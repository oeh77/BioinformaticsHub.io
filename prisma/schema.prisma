datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  password      String?
  role          String    @default("USER") // ADMIN, EDITOR, USER
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  accounts      Account[]
  sessions      Session[]
  bookmarks     Bookmark[]
  paymentMethods PaymentMethod[]
  reviews       Review[]
  stacks        Stack[]
  toolSuggestions ToolSuggestion[]
  searchHistory SearchHistory[]
  savedSearches SavedSearch[]
  
  // Notifications
  notifications          Notification[]
  notificationPreference NotificationPreference?
  pushSubscriptions      PushSubscription[]
  
  // Workflows
  workflows     Workflow[]
  
  // Q&A Forum
  reputation    Int       @default(0)
  questions     Question[] @relation("QuestionAuthor")
  answers       Answer[]   @relation("AnswerAuthor")
  questionVotes QuestionVote[] @relation("QuestionVotes")
  answerVotes   AnswerVote[]   @relation("AnswerVotes")
  badges        UserBadge[]
  
  // Preferences
  language        String    @default("en")
  marketingEmails Boolean   @default(true)
  securityEmails  Boolean   @default(true)
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  type        String   @default("TOOL") // TOOL, COURSE, POST
  tools       Tool[]
  courses     Course[]
  posts       Post[]
  resources   Resource[]
}

model Tool {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String
  content     String?
  url         String?
  pricing     String?
  image       String?
  published   Boolean  @default(true)
  featured    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  reviews     Review[]
  stackTools  StackTool[]
  
  // External links for stats
  githubUrl   String?
  npmPackage  String?
  pypiPackage String?
  
  metaTitle   String?
  metaDesc    String?
}

model Course {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  provider    String
  level       String
  description String
  url         String?
  image       String?
  published   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
}

model Resource {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  type        String
  description String
  url         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  String?
  category    Category? @relation(fields: [categoryId], references: [id])
}

model Post {
  id          String   @id @default(cuid())
  title       String
  slug        String   @unique
  excerpt     String?
  content     String
  image       String?
  published   Boolean  @default(false)
  authorId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  categoryId  String
  category    Category @relation(fields: [categoryId], references: [id])
  
  metaTitle   String?
  metaDesc    String?
  
  // Auto-blogging metadata
  sourceUrl       String?
  images          String?   // JSON array of additional image URLs
  videoUrl        String?
  isAutoGenerated Boolean   @default(false)
  generatedAt     DateTime?
}

model Subscriber {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  status    String   @default("SUBSCRIBED")
  createdAt DateTime @default(now())
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  encrypted Boolean  @default(false)
}

model Bookmark {
  id        String   @id @default(cuid())
  userId    String
  itemType  String   // TOOL, COURSE, RESOURCE
  itemId    String
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, itemType, itemId])
  @@index([userId])
}

model Integration {
  id          String   @id @default(cuid())
  name        String
  provider    String   // twitter, linkedin, facebook, zapier, slack, salesforce, custom
  category    String   // social, automation, erp, other
  description String?
  image       String?
  isConnected Boolean  @default(false)
  
  // Storing config as a JSON string since shapes vary heavily by provider
  // e.g. { clientId, clientSecret, webhookUrl, apiKey, ... }
  config      String   @default("{}") 
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ApiKey {
  id                String         @id @default(cuid())
  name              String
  description       String?
  key               String         @unique  // Public API key (e.g., "bhio_live_abc123...")
  secretHash        String         // Hashed secret key (bcrypt)
  userId            String
  
  // Permissions/scopes
  scopes            String         @default("[]")  // JSON array: ["tools:read", "courses:read", "tools:write", etc.]
  
  // Rate limiting
  requestsPerHour   Int            @default(1000)
  requestsPerDay    Int            @default(10000)
  
  // IP whitelist (comma-separated IPs or CIDR ranges)
  ipWhitelist       String?
  
  // Status
  isActive          Boolean        @default(true)
  expiresAt         DateTime?
  lastUsedAt        DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  
  usage             ApiKeyUsage[]
  
  @@index([userId])
  @@index([key])
}

model ApiKeyUsage {
  id          String   @id @default(cuid())
  apiKeyId    String
  apiKey      ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)
  
  endpoint    String   // e.g., "/api/v1/tools"
  method      String   // GET, POST, PUT, DELETE
  statusCode  Int      // HTTP status code
  ipAddress   String
  userAgent   String?
  
  timestamp   DateTime @default(now())
  
  @@index([apiKeyId])
  @@index([timestamp])
}

model Webhook {
  id          String            @id @default(cuid())
  name        String
  description String?
  url         String            // Webhook endpoint URL
  secret      String            // Secret for HMAC signature verification
  
  // Events to subscribe to (JSON array)
  // e.g., ["tool.created", "tool.updated", "course.created", etc.]
  events      String            @default("[]")
  
  isActive    Boolean           @default(true)
  userId      String
  
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  
  deliveries  WebhookDelivery[]
  
  @@index([userId])
}

model WebhookDelivery {
  id           String   @id @default(cuid())
  webhookId    String
  webhook      Webhook  @relation(fields: [webhookId], references: [id], onDelete: Cascade)
  
  event        String   // e.g., "tool.created"
  payload      String   // JSON payload sent
  
  statusCode   Int?     // HTTP response status code
  response     String?  // Response body (if any)
  error        String?  // Error message if failed
  
  attemptCount Int      @default(1)
  succeeded    Boolean  @default(false)
  
  deliveredAt  DateTime @default(now())
  
  @@index([webhookId])
  @@index([deliveredAt])
}

model PaymentMethod {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  provider    String   // e.g., "stripe"
  providerId  String   // e.g., Stripe customer ID or payment method ID
  last4       String?  // last 4 digits for display
  brand       String?  // Visa, MasterCard, etc.
  expMonth    Int?
  expYear     Int?
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int      // 1-5
  title     String?
  content   String
  status    String   @default("approved") // pending, approved, rejected
  userId    String
  toolId    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([userId, toolId])
  @@index([toolId])
  @@index([status])
}

model Stack {
  id          String      @id @default(cuid())
  name        String
  slug        String      @unique
  description String?
  isPublic    Boolean     @default(true)
  userId      String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tools       StackTool[]

  @@index([userId])
}

model StackTool {
  id       String   @id @default(cuid())
  stackId  String
  toolId   String
  addedAt  DateTime @default(now())

  stack    Stack    @relation(fields: [stackId], references: [id], onDelete: Cascade)
  tool     Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@unique([stackId, toolId])
}

model Job {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  company       String
  companyLogo   String?
  location      String    // "Remote", "San Francisco, CA", etc.
  locationType  String    @default("Remote") // Remote, Hybrid, On-site
  employmentType String   @default("Full-time") // Full-time, Part-time, Contract
  salaryMin     Int?
  salaryMax     Int?
  salaryCurrency String?  @default("USD")
  description   String    // Rich text / HTML
  requirements  String?   // Rich text
  benefits      String?
  applicationUrl String?
  applicationEmail String?
  tags          String?   // Comma-separated: "python,bioinformatics,genomics"
  featured      Boolean   @default(false)
  published     Boolean   @default(true)
  expiresAt     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([published, expiresAt])
  @@index([featured])
}

model ToolSuggestion {
  id          String   @id @default(cuid())
  name        String
  website     String?
  description String
  category    String?
  status      String   @default("pending") // pending, approved, rejected
  adminNotes  String?
  userId      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user        User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([status])
}

model AutoBlogJob {
  id           String   @id @default(cuid())
  status       String   @default("pending") // pending, processing, completed, failed
  categoryId   String
  categoryName String?
  topic        String?
  result       String?  // JSON with generated post data
  postId       String?  // Reference to created Post
  error        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([status])
  @@index([categoryId])
}

model SearchHistory {
  id          String   @id @default(cuid())
  userId      String
  query       String
  resultCount Int      @default(0)
  filters     String?  // JSON with applied filters
  createdAt   DateTime @default(now())

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model SavedSearch {
  id            String   @id @default(cuid())
  userId        String
  name          String
  query         String
  filters       String?  // JSON with saved filters
  notifications Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// AFFILIATE MARKETING SYSTEM
// ============================================

// Affiliate Partners - Companies we partner with (Illumina, Thermo Fisher, etc.)
model AffiliatePartner {
  id                   String   @id @default(cuid())
  companyName          String   // e.g., "Illumina", "Thermo Fisher"
  slug                 String   @unique
  industryCategory     String   // software, equipment, services, education, reagents
  websiteUrl           String?
  logoUrl              String?
  description          String?
  
  // Commission settings
  commissionRate       Float    @default(10.0) // Percentage
  commissionType       String   @default("percentage") // percentage, fixed, tiered, hybrid
  cookieDuration       Int      @default(30) // Days
  paymentTerms         String?  @default("Net 30")
  
  // Network integration
  affiliateNetwork     String?  // ShareASale, CJ, Impact, Direct
  networkAccountId     String?
  apiKey               String?  // Encrypted in practice
  apiEndpoint          String?
  
  // Status & contract
  status               String   @default("pending") // active, pending, paused, terminated
  contractStartDate    DateTime?
  contractEndDate      DateTime?
  
  // Payment settings
  minPayoutThreshold   Float    @default(50.0)
  payoutThreshold      Float    @default(50.0)  // Alias for API compatibility
  paymentMethod        String   @default("paypal") // paypal, bank_transfer, check, network
  payoutMethod         String   @default("paypal") // Alias for API compatibility
  paymentDetails       String?  // JSON-encoded payment details
  
  // Contact info
  contactName          String?
  contactEmail         String?
  notes                String?
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  products             AffiliateProduct[]
  links                AffiliateLink[]
  clicks               AffiliateClick[]
  conversions          AffiliateConversion[]
  payouts              AffiliatePayout[]
  contentAssets        AffiliateContentAsset[]
  apiLogs              PartnerApiLog[]
  campaigns            AffiliateCampaign[]
  
  @@index([status])
  @@index([industryCategory])
}


// Affiliate Products - Individual products/services we promote
model AffiliateProduct {
  id                   String   @id @default(cuid())
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  productName          String   // "NovaSeq 6000", "Galaxy Cloud Platform"
  slug                 String   @unique
  productCategory      String   // sequencer, software, cloud, reagent, course, book
  subcategory          String?  // NGS, RNA-Seq, Proteomics
  description          String?
  features             String?  // JSON array of key features
  
  // Pricing
  price                Float?
  currency             String   @default("USD")
  pricingModel         String   @default("one_time") // one_time, subscription, usage_based
  
  // URLs
  productUrl           String?  // Direct product page
  affiliateUrl         String?  // Trackable affiliate link
  
  // Media
  imageUrls            String?  // JSON array of product images
  videoUrl             String?
  datasheetUrl         String?
  
  // Visibility
  isFeatured           Boolean  @default(false)
  popularityScore      Int      @default(0)
  
  // Override partner commission for this product
  commissionOverride   Float?
  
  trackingEnabled      Boolean  @default(true)
  status               String   @default("active") // active, inactive, out_of_stock
  tags                 String?  // JSON array: ["genomics", "RNA", "automation"]
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  links                AffiliateLink[]
  clicks               AffiliateClick[]
  conversions          AffiliateConversion[]
  
  @@index([partnerId])
  @@index([productCategory])
  @@index([status])
  @@index([isFeatured])
}

// Affiliate Links - Trackable short links
model AffiliateLink {
  id                   String   @id @default(cuid())
  shortCode            String   @unique  // e.g., "bh-illumina-ns6k"
  name                 String?  // Optional display name
  
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  productId            String?
  product              AffiliateProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  campaignId           String?
  campaign             AffiliateCampaign? @relation(fields: [campaignId], references: [id], onDelete: SetNull)
  
  originalUrl          String   // Full partner URL
  trackingUrl          String?  // URL with tracking parameters
  shortUrl             String?  // e.g., "bioinformaticshub.io/go/ns6k"
  
  linkType             String   @default("product") // product, category, homepage, custom
  placementType        String   @default("content") // content, banner, button, widget, email
  
  // UTM parameters
  utmSource            String?
  utmMedium            String?
  utmCampaign          String?
  customParameters     String?  // JSON - additional tracking params
  
  createdBy            String?  // User ID if created by a user
  status               String   @default("active") // active, inactive, expired
  expiresAt            DateTime?
  
  // Stats cache
  totalClicks          Int      @default(0)
  totalConversions     Int      @default(0)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  clicks               AffiliateClick[]
  
  @@index([partnerId])
  @@index([productId])
  @@index([campaignId])
  @@index([shortCode])
  @@index([status])
}


// Affiliate Clicks - Click tracking events
model AffiliateClick {
  id                   String   @id @default(cuid())
  
  linkId               String
  link                 AffiliateLink @relation(fields: [linkId], references: [id], onDelete: Cascade)
  
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  productId            String?
  product              AffiliateProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)
  
  // User tracking
  userId               String?  // If logged in user
  sessionId            String   // Anonymous tracking
  
  // Request info
  ipAddress            String?
  userAgent            String?
  referrer             String?
  
  // Geo & device info
  countryCode          String?  // 2-letter ISO code
  deviceType           String?  // desktop, mobile, tablet
  browser              String?
  os                   String?
  
  // Bot detection
  isBot                Boolean  @default(false)
  botType              String?  // googlebot, bingbot, etc.
  
  clickedAt            DateTime @default(now())
  
  // Conversion link (if converted)
  conversionId         String?
  
  @@index([linkId, clickedAt])
  @@index([partnerId, clickedAt])
  @@index([sessionId, clickedAt])
  @@index([productId])
}

// Affiliate Conversions - When a click leads to a sale/signup
model AffiliateConversion {
  id                   String   @id @default(cuid())
  
  clickId              String?  // May not have click if using postback
  linkId               String?  // Direct link reference
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  productId            String?
  product              AffiliateProduct? @relation(fields: [productId], references: [id], onDelete: SetNull)

  
  // Order info
  orderId              String?  // Partner's order ID
  transactionId        String?  // Network transaction ID
  
  conversionType       String   @default("sale") // sale, lead, signup, trial, download
  
  // Financial
  saleAmount           Float?
  commissionAmount     Float    @default(0)
  currency             String   @default("USD")
  
  // Status workflow
  conversionStatus     String   @default("pending") // pending, approved, rejected, reversed
  convertedAt          DateTime @default(now())
  approvedAt           DateTime?
  
  // Payout tracking
  payoutStatus         String   @default("unpaid") // unpaid, processing, paid
  payoutId             String?
  payout               AffiliatePayout? @relation(fields: [payoutId], references: [id], onDelete: SetNull)
  
  // Validation
  validationMethod     String   @default("postback") // postback, api, csv, manual
  metadata             String?  // JSON - additional conversion data
  notes                String?
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@index([partnerId, convertedAt])
  @@index([conversionStatus, payoutStatus])
  @@index([payoutId])
}

// Affiliate Payouts - Payment records
model AffiliatePayout {
  id                   String   @id @default(cuid())
  
  partnerId            String?  // Nullable for multi-partner payouts
  partner              AffiliatePartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  
  payoutPeriodStart    DateTime
  payoutPeriodEnd      DateTime
  
  totalConversions     Int      @default(0)
  totalCommission      Float    @default(0)
  currency             String   @default("USD")
  
  payoutMethod         String   @default("paypal") // paypal, bank_transfer, check, network
  payoutStatus         String   @default("pending") // pending, processing, completed, failed
  payoutDate           DateTime?
  
  transactionReference String?
  invoiceUrl           String?
  notes                String?
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  conversions          AffiliateConversion[]
  
  @@index([partnerId])
  @@index([payoutStatus])
}

// Affiliate Content Assets - Banners, images, videos
model AffiliateContentAsset {
  id                   String   @id @default(cuid())
  
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  assetType            String   // banner, image, video, logo, pdf
  fileName             String
  fileUrl              String
  fileSize             Int      @default(0) // Bytes
  mimeType             String?
  dimensions           String?  // "728x90", "300x250", "1920x1080"
  
  title                String
  altText              String?
  description          String?
  
  assetCategory        String   @default("product") // product, brand, promotional, educational
  isApproved           Boolean  @default(false)
  downloadCount        Int      @default(0)
  tags                 String?  // JSON array
  
  uploadedBy           String   @default("admin") // "partner" or "admin"
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@index([partnerId])
  @@index([assetType])
  @@index([isApproved])
}

// Affiliate Campaigns - Promotional campaigns
model AffiliateCampaign {
  id                   String   @id @default(cuid())
  
  campaignName         String   // "Black Friday 2026 NGS Deals"
  campaignCode         String   @unique // "bf2026-ngs"
  slug                 String?  @unique // URL-friendly identifier
  
  partnerId            String?  // Optional partner ID for partner-specific campaigns
  partner              AffiliatePartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  partnerIds           String?  // JSON array of participating partner IDs
  campaignType         String   @default("general") // seasonal, product_launch, category_promo, general
  
  startDate            DateTime
  endDate              DateTime?
  
  // Budget and Targets
  budgetAmount         Float?   // Campaign budget
  targetClicks         Int?     // Target clicks
  targetConversions    Int?     // Target conversions
  targetRevenue        Float?   // Target revenue
  
  // Commission Bonus
  bonusCommissionRate  Float?   // Additional % on top of base
  bonusCommission      Float?   // Flat bonus amount
  
  // Discount Settings
  discountCode         String?  // Promo code for this campaign
  discountAmount       Float?   // Discount value
  discountType         String?  // "percentage" or "fixed"
  
  description          String?
  terms                String?  // Special terms for this campaign
  landingPageUrl       String?
  creativeAssets       String?  // JSON array of asset IDs
  creatives            String?  // JSON array of creative URLs
  creativesUrls        String?  // JSON array of creative URLs (alias)
  notificationEmails   String?  // JSON array of emails to notify
  utmSource            String?  // UTM source parameter
  utmMedium            String?  // UTM medium parameter
  utmCampaign          String?  // UTM campaign parameter
  utmParams            String?  // JSON object for additional UTM parameters
  
  status               String   @default("draft") // draft, active, paused, completed, cancelled
  performanceSummary   String?  // JSON - cached stats
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  links                AffiliateLink[]
  
  @@index([status])
  @@index([partnerId])
  @@index([startDate, endDate])
}


// Affiliate Disclosures - FTC compliance
model AffiliateDisclosure {
  id                   String   @id @default(cuid())
  
  contentId            String?  // Link to your content (articles, pages)
  
  disclosureType       String   @default("banner") // banner, inline, popup, page_footer
  disclosureText       String   // FTC-compliant disclosure text
  position             String   @default("top") // top, middle, bottom, floating
  
  isRequired           Boolean  @default(true)
  isDisplayed          Boolean  @default(true)
  language             String   @default("en")
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@index([contentId])
  @@index([disclosureType])
}

// Partner API Logs - Audit trail for partner API calls
model PartnerApiLog {
  id                   String   @id @default(cuid())
  
  partnerId            String
  partner              AffiliatePartner @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  apiEndpoint          String
  requestMethod        String   // GET, POST, etc.
  requestPayload       String?  // JSON
  
  responseStatus       Int      @default(0)
  responseBody         String?  // JSON
  responseTimeMs       Int      @default(0)
  
  errorMessage         String?
  
  createdAt            DateTime @default(now())
  
  @@index([partnerId, createdAt])
}

// ============================================
// MENU CONFIGURATION SYSTEM
// ============================================

// Menu Sections - Groups of menu items (e.g., "Discover", "Resources", "Legal" for footer)
model MenuSection {
  id          String     @id @default(cuid())
  name        String     // Display name (e.g., "Discover", "Resources")
  slug        String     @unique // Unique identifier
  location    String     // "header", "footer", "mobile"
  position    Int        @default(0) // Order within location
  isEnabled   Boolean    @default(true)
  
  // Styling
  icon        String?    // Lucide icon name
  iconColor   String?    // Tailwind color class
  
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  items       MenuItem[]
  
  @@index([location])
  @@index([position])
}

// Menu Items - Individual navigation links
model MenuItem {
  id          String       @id @default(cuid())
  label       String       // Display text
  href        String       // Navigation URL
  
  sectionId   String?
  section     MenuSection? @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  
  parentId    String?      // For nested items (dropdowns)
  parent      MenuItem?    @relation("MenuItemChildren", fields: [parentId], references: [id], onDelete: SetNull)
  children    MenuItem[]   @relation("MenuItemChildren")
  
  position    Int          @default(0) // Order within section/parent
  isEnabled   Boolean      @default(true)
  openInNewTab Boolean     @default(false)
  
  // Styling
  icon        String?      // Lucide icon name
  iconColor   String?      // Tailwind color class (e.g., "text-blue-400")
  gradient    String?      // Hover gradient (e.g., "from-blue-500/10 to-purple-500/10")
  description String?      // For mega-menu items
  
  // Type
  itemType    String       @default("link") // "link", "dropdown", "mega", "divider"
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  @@index([sectionId])
  @@index([parentId])
  @@index([position])
}

// ============================================
// MONETIZATION SETTINGS
// ============================================

// Stores all ad-related configuration for the site
model MonetizationSettings {
  id                   String   @id @default(cuid())
  
  // Master Controls
  adsEnabled           Boolean  @default(true)
  adDensity            String   @default("medium") // low, medium, high
  debugMode            Boolean  @default(false)
  
  // Network Toggles
  carbonEnabled        Boolean  @default(true)
  adsenseEnabled       Boolean  @default(true)
  
  // Carbon Ads Config
  carbonServeUrl       String   @default("https://cdn.carbonads.com/carbon.js")
  carbonPlacement      String   @default("bioinformaticshubio")
  carbonServeId        String?  // Encrypted in production
  
  // Google AdSense Config
  adsenseClientId      String?  // ca-pub-XXXXX
  adsenseSlotFooter    String?
  adsenseSlotInContent String?
  adsenseSlotSidebar   String?
  adsenseSlotHeader    String?
  
  // Page Settings (JSON)
  pageSettings         String   @default("{\"tools\":true,\"blog\":true,\"courses\":true,\"jobs\":true,\"resources\":true,\"directory\":true,\"compare\":true,\"home\":true}")
  
  // Placement Settings (JSON)
  placementSettings    String   @default("{\"header\":true,\"footer\":true,\"sidebar\":true,\"sidebarSticky\":true,\"inContent\":true,\"beforeComments\":false,\"afterHero\":true,\"betweenCards\":true,\"endOfPage\":true}")
  
  // A/B Testing (JSON)
  abTestingConfig      String   @default("{\"enabled\":false,\"sidebarExperiment\":false,\"footerExperiment\":false,\"inContentExperiment\":false}")
  
  // Premium Experience
  premiumAdFree        Boolean  @default(false)
  
  // Analytics
  trackImpressions     Boolean  @default(true)
  trackClicks          Boolean  @default(true)
  gaPropertyId         String?  // Google Analytics property ID
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}

// Ad Placements - Granular control over individual ad spots
model AdPlacement {
  id                String   @id @default(cuid())
  
  placementId       String   @unique  // e.g., "tool-hero", "blog-sidebar"
  name              String   // Human-readable name
  description       String?
  
  // Location
  pageType          String   // tools, blog, courses, jobs, resources, global
  position          String   // header, footer, sidebar, in-content, after-hero, etc.
  
  // Network
  network           String   @default("carbon") // carbon, adsense, both
  adsenseSlotId     String?
  
  // Format
  format            String   @default("native") // native, display, banner, rectangle
  width             Int?
  height            Int?
  
  // Priority (1-10, higher = more important)
  priority          Int      @default(5)
  
  // Density Control
  minDensity        String   @default("low") // low, medium, high
  
  // Status
  isEnabled         Boolean  @default(true)
  
  // Scheduling
  startDate         DateTime?
  endDate           DateTime?
  
  // Custom CSS Class
  customClass       String?
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([pageType])
  @@index([position])
  @@index([isEnabled])
}

// Sponsored Content - Native sponsored cards/posts
model SponsoredContent {
  id                String   @id @default(cuid())
  
  title             String
  description       String?
  imageUrl          String?
  href              String   // Link to sponsor's page
  
  sponsor           String   // Sponsor name
  category          String?  // Product category for targeting
  
  // Targeting
  targetPages       String   @default("[]") // JSON array of page types
  targetCategories  String   @default("[]") // JSON array of category slugs
  
  // Display
  priority          Int      @default(5)
  position          Int      @default(0) // Position in listings
  
  // Scheduling
  startDate         DateTime?
  endDate           DateTime?
  
  // Status
  isEnabled         Boolean  @default(true)
  
  // Analytics
  impressions       Int      @default(0)
  clicks            Int      @default(0)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([isEnabled])
  @@index([startDate, endDate])
}

// ============================================
// NOTIFICATION SYSTEM
// ============================================

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        String   // tool_update, review_reply, job_match, new_tool, mention, etc.
  title       String
  message     String
  link        String?  // URL to navigate when clicked
  icon        String?  // Icon name or URL
  
  isRead      Boolean  @default(false)
  isArchived  Boolean  @default(false)
  
  // Optional reference to related content
  relatedType String?  // tool, course, job, post, review
  relatedId   String?
  
  metadata    String?  // JSON string for additional data
  
  createdAt   DateTime @default(now())
  readAt      DateTime?
  
  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@index([createdAt])
}

model NotificationPreference {
  id              String  @id @default(cuid())
  userId          String  @unique
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Master switch
  enabled         Boolean @default(true)
  
  // Email notifications
  emailEnabled    Boolean @default(true)
  emailFrequency  String  @default("daily") // instant, daily, weekly, never
  
  // Push notifications
  pushEnabled     Boolean @default(true)
  
  // Notification types - what to receive
  toolUpdates     Boolean @default(true)   // Updates to bookmarked tools
  reviewReplies   Boolean @default(true)   // Replies to your reviews
  jobMatches      Boolean @default(true)   // New jobs matching interests
  newInCategory   Boolean @default(false)  // New tools in followed categories
  weeklyDigest    Boolean @default(true)   // Weekly digest email
  mentions        Boolean @default(true)   // When someone mentions you
  systemAnnouncements Boolean @default(true) // Platform updates
  
  // Quiet hours
  quietHoursEnabled Boolean @default(false)
  quietHoursStart   String  @default("22:00")
  quietHoursEnd     String  @default("08:00")
  timezone          String  @default("UTC")
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model PushSubscription {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  endpoint    String   @unique
  p256dh      String   // Public key
  auth        String   // Auth secret
  
  userAgent   String?  // Browser/device info
  
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  lastUsedAt  DateTime?
  
  @@index([userId])
  @@index([isActive])
}

// Admin broadcast notifications
model BroadcastNotification {
  id          String   @id @default(cuid())
  
  title       String
  message     String
  link        String?
  icon        String?
  
  // Targeting
  targetRoles String   @default("[\"USER\"]") // JSON array of roles
  targetAll   Boolean  @default(true)
  
  // Scheduling
  scheduledAt DateTime?
  sentAt      DateTime?
  
  // Stats
  recipientCount Int   @default(0)
  readCount      Int   @default(0)
  clickCount     Int   @default(0)
  
  createdBy   String?
  
  createdAt   DateTime @default(now())
  
  @@index([sentAt])
  @@index([scheduledAt])
}

// ============================================
// ANALYTICS & TRACKING
// ============================================

model PageView {
  id          String   @id @default(cuid())
  
  contentType String   // tool, course, post, job, page
  contentId   String?  // ID of the content (null for static pages)
  path        String   // Full URL path
  
  userId      String?  // Logged in user (optional)
  sessionId   String   // Anonymous session ID
  
  referrer    String?
  userAgent   String?
  country     String?
  city        String?
  
  duration    Int?     // Time spent on page in seconds
  
  createdAt   DateTime @default(now())
  
  @@index([contentType, contentId])
  @@index([createdAt])
  @@index([sessionId])
}

model DailyStats {
  id          String   @id @default(cuid())
  
  date        DateTime
  contentType String
  contentId   String
  
  views       Int      @default(0)
  uniqueViews Int      @default(0)
  avgDuration Int      @default(0)
  
  @@unique([date, contentType, contentId])
  @@index([date])
  @@index([contentType, contentId])
}

model TrendingContent {
  id          String   @id @default(cuid())
  
  period      String   // daily, weekly, monthly
  contentType String   // tool, course, post, job
  contentId   String
  
  score       Float    @default(0)  // Calculated trending score
  rank        Int
  
  views       Int      @default(0)
  growth      Float    @default(0)  // % growth from previous period
  
  calculatedAt DateTime @default(now())
  
  @@unique([period, contentType, contentId])
  @@index([period, rank])
}

// ============================================
// WORKFLOW BUILDER
// ============================================

model Workflow {
  id          String   @id @default(cuid())
  slug        String   @unique
  name        String
  description String?
  authorId    String
  author      User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  
  nodes       String   @default("[]")  // JSON: React Flow nodes
  edges       String   @default("[]")  // JSON: React Flow edges
  viewport    String?  // JSON: Canvas position
  
  isPublic    Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  
  views       Int      @default(0)
  forks       Int      @default(0)
  forkedFromId String?
  
  tags        String   @default("[]")  // JSON array of tag names
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  exports     WorkflowExport[]
  
  @@index([authorId])
  @@index([isPublic])
}

model WorkflowExport {
  id          String   @id @default(cuid())
  workflowId  String
  workflow    Workflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  format      String   // cwl, nextflow, snakemake
  code        String   // Generated code
  version     String
  createdAt   DateTime @default(now())
  
  @@index([workflowId])
}

// ============================================
// COMMUNITY Q&A FORUM
// ============================================

model Question {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  body        String
  authorId    String
  author      User     @relation("QuestionAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  views       Int      @default(0)
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  
  isAnswered  Boolean  @default(false)
  isClosed    Boolean  @default(false)
  isPinned    Boolean  @default(false)
  
  answers     Answer[]
  tags        QuestionTag[]
  votes       QuestionVote[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([authorId])
  @@index([createdAt])
  @@index([isAnswered])
}

model Answer {
  id          String   @id @default(cuid())
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  authorId    String
  author      User     @relation("AnswerAuthor", fields: [authorId], references: [id], onDelete: Cascade)
  
  body        String
  upvotes     Int      @default(0)
  downvotes   Int      @default(0)
  isAccepted  Boolean  @default(false)
  
  votes       AnswerVote[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([questionId])
  @@index([authorId])
}

model ForumTag {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  toolId      String?  // Link to tool if tag represents a tool
  color       String   @default("#6366f1")
  
  questions   QuestionTag[]
  
  @@index([slug])
}

model QuestionTag {
  id          String   @id @default(cuid())
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  tagId       String
  tag         ForumTag @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([questionId, tagId])
}

model QuestionVote {
  id          String   @id @default(cuid())
  questionId  String
  question    Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("QuestionVotes", fields: [userId], references: [id], onDelete: Cascade)
  value       Int      // 1 or -1
  
  @@unique([questionId, userId])
}

model AnswerVote {
  id          String   @id @default(cuid())
  answerId    String
  answer      Answer   @relation(fields: [answerId], references: [id], onDelete: Cascade)
  userId      String
  user        User     @relation("AnswerVotes", fields: [userId], references: [id], onDelete: Cascade)
  value       Int      // 1 or -1
  
  @@unique([answerId, userId])
}

model Badge {
  id          String   @id @default(cuid())
  name        String   @unique
  description String
  icon        String
  type        String   // bronze, silver, gold
  criteria    String   // JSON: e.g., { answers: 10, upvotes: 100 }
  
  users       UserBadge[]
}

model UserBadge {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badgeId   String
  badge     Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  awardedAt DateTime @default(now())
  
  @@unique([userId, badgeId])
}
